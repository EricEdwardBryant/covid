---
title: Homepage
author: Eric Bryant, PhD
include-before: >
  First time here? Check out the [FAQ](/faq/)! Otherwise, jump to:
output:
  blogdown::html_page:
    toc: yes
---



```{r include = FALSE}
# Load R packages, functions, and settings
source(here::here("requirements.R"))

# Where to save new cases in CA
csv_cases <- here("data/new-cases-ca-v2.csv")
csv_hsp   <- here("data/hospitalization-ca-v2.csv")

# ---- !!! Population data now provided from CA directly as of 2021-03-13 ----
# Population from: https://worldpopulationreview.com/us-counties/ca/los-angeles-county-population
#la_population <- 10079000

# Population from: https://worldpopulationreview.com/us-counties/ca/santa-clara-county-population
#sc_population <- 1945940
# ---- !!! -------------------------------------------------------------------

# Range of dates
#dates <- lubridate::today("UTC") + c(-255, 110)
#dates <- lubridate::today("UTC") + c(-500, 150)
dates <- c(as.Date("2020-11-01"), lubridate::today("UTC") + 150)

# Download data from https://data.ca.gov
# Only downloads once a day unless force = TRUE
download_new_cases_ca_csv_v2(csv_cases)
download_hospitalization_ca_csv_v2(csv_hsp)
```

**UPDATE 2021-12-17:** O.M.I.C.R.O.N REVIVAL. Katrina, do. not. panic... yet!

Los Angeles
--------------------------------------------------------------------------------

For the most recent information, I recommend reading the
[LA county public health press releases](http://publichealth.lacounty.gov/media/coronavirus/#news).

```{r covid-los-angeles, fig.height = 7}
county <- "Los Angeles"

la_population <-
  read_csv(csv_cases, col_types = cols()) %>%
  filter(county == {{ county }}) %>%
  pull(population) %>%
  median() # compromise since second scale needs to be a linear transformation

figure_new_cases(csv_cases, county, population = la_population, date_limits = dates) /
  figure_new_cases_change(csv_cases, county, date_limits = dates) /
  figure_hospitalization(csv_hsp, county, date_limits = dates)
```


Adding numbers for last 30 days since there are lots of reporting dips and
spikes, so it can be usefull to crossreference with recent numbers.

```{r covid,-los-angeles-table-01}
df_cases <-
  read_csv(csv_cases, col_types = cols()) %>%
  filter(.data$county == .env$county) %>%
  # Calculate estimates
  arrange(date) %>%
  mutate(
    count_new_roll  = slide_dbl(count_new, median, .before = 7L, .after = 7L),
    count_new_loess = predict_loess(date, count_new, span = 0.11),
    count_new_loess_diff = count_new_loess - lag(count_new_loess),
    count_new_loess_fc   = count_new_loess / lag(count_new_loess),
    count_new_loess_diff_weekly = count_new_loess - lag(count_new_loess, 7L),
    count_new_loess_fc_weekly = count_new_loess / lag(count_new_loess, 7L)
  ) %>%
  top_n(30, date) %>%
  select(
    Date = date,
    "New cases" = count_new,
    "Smooth estimate" = count_new_loess,
    "2 week median" = count_new_roll,
    "Daily change" = count_new_loess_diff,
    "Weekly change" = count_new_loess_diff_weekly,
    "Daily fold change" = count_new_loess_fc,
    "Weekly fold change" = count_new_loess_fc_weekly
  )

df_hsp <-
  read_csv(csv_hsp, col_types = cols()) %>%
  # Date hard censored due to change in reporting criteria
  filter(.data$county == .env$county, date >= as.Date("2020-05-01")) %>%
  top_n(30, date) %>%
  # Combine confirmed and suspected counts (at this point most are confirmed)
  # In the spring there were more "suspected" probably due to testing backlogs?
  mutate(
    hsp = hsp_covid_confirmed + hsp_covid_suspected,
    icu = icu_covid_confirmed + icu_covid_suspected,
    hsp = hsp - icu # remove ICU cases from inpatient (the figure will stack)
  ) %>%
  select(Date = date, "Hospitalized" = hsp, "ICU" = icu, "Open ICU beds" = icu_available_beds)

df_hsp %>%
  left_join(df_cases, by = "Date") %>%
  arrange(desc(Date)) %>%
  #mutate(across(where(is_double) & !Date, ~as.integer(round(.)))) %>%
  gt::gt() %>%
  gt::fmt_number(columns = c(`Smooth estimate`, `2 week median`, `Daily change`, `Weekly change`), decimal = 0) %>%
  gt::fmt_number(columns = ends_with("fold change"), decimal = 2) %>%
  gt::cols_width(
    Date ~ px(100),
    ICU  ~ px(80)
  ) %>%
  gt::gtsave(paste0(tempfile(), ".png"))
```


Santa Clara
--------------------------------------------------------------------------------

For the most recent information, I recommend reading the
[Santa Clara county public health press releases](https://www.sccgov.org/sites/covid19/Pages/archives.aspx).

```{r covid-santa-clara, fig.height = 7}
county <- "Santa Clara"

sc_population <-
  read_csv(csv_cases, col_types = cols()) %>%
  filter(county == {{ county }}) %>%
  pull(population) %>%
  median() # compromise since second scale needs to be a linear transformation

figure_new_cases(csv_cases, county, population = sc_population, date_limits = dates) /
  figure_new_cases_change(csv_cases, county, date_limits = dates) / 
  figure_hospitalization(csv_hsp, county, date_limits = dates)
```
